<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>FastMODA - Coherence Analysis</title>
    <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }
      h1 {
        color: #333;
        border-bottom: 3px solid #2196F3;
        padding-bottom: 10px;
      }
      .upload-form {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 20px;
      }
      .upload-form label {
        display: block;
        margin-top: 10px;
        font-weight: bold;
        color: #555;
      }
      .upload-form input, .upload-form button {
        margin: 10px 0;
        padding: 10px;
        width: 100%;
        box-sizing: border-box;
      }
      button {
        background: #2196F3;
        color: white;
        border: none;
        cursor: pointer;
        font-size: 16px;
        border-radius: 4px;
      }
      button:hover { background: #0b7dda; }
      button:disabled {
        background: #ccc;
        cursor: not-allowed;
      }
      .file-list {
        background: #f0f0f0;
        padding: 10px;
        border-radius: 4px;
        margin-top: 10px;
        min-height: 40px;
      }
      .file-item {
        background: white;
        padding: 8px;
        margin: 5px 0;
        border-radius: 4px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .file-item button {
        width: auto;
        padding: 5px 10px;
        margin: 0;
        background: #f44336;
        font-size: 14px;
      }
      .progress-container {
        display: none;
        background: white;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
      }
      .progress-bar {
        width: 100%;
        height: 30px;
        background: #e0e0e0;
        border-radius: 15px;
        overflow: hidden;
        position: relative;
      }
      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #2196F3, #0b7dda);
        transition: width 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
      }
      .progress-stage {
        margin-top: 10px;
        color: #666;
        font-style: italic;
      }
      .info-box {
        background: #e3f2fd;
        border-left: 4px solid #2196F3;
        padding: 15px;
        margin: 15px 0;
        border-radius: 4px;
      }
      .warning {
        background: #fff3cd;
        border-left: 4px solid #ffc107;
        padding: 10px;
        margin: 10px 0;
        border-radius: 4px;
      }
      .error {
        background: #ffebee;
        border-left: 4px solid #f44336;
        padding: 10px;
        margin: 10px 0;
        border-radius: 4px;
        color: #c62828;
      }
      .results {
        display: none;
      }
      .plot-container {
        background: white;
        padding: 20px;
        margin: 20px 0;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      .pair-selector {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin: 20px 0;
      }
      .pair-button {
        padding: 10px 15px;
        background: #e0e0e0;
        border: 2px solid transparent;
        cursor: pointer;
        border-radius: 4px;
        transition: all 0.3s;
      }
      .pair-button:hover {
        background: #d0d0d0;
      }
      .pair-button.active {
        background: #2196F3;
        color: white;
        border-color: #0b7dda;
      }
      .gpu-badge {
        display: inline-block;
        padding: 5px 10px;
        background: #4CAF50;
        color: white;
        border-radius: 4px;
        font-size: 12px;
        font-weight: bold;
        margin-left: 10px;
      }
      .back-link {
        display: inline-block;
        margin-top: 20px;
        color: #2196F3;
        text-decoration: none;
        font-weight: bold;
      }
      .back-link:hover {
        text-decoration: underline;
      }
    </style>
  </head>
  <body>
    <h1>
      FastMODA - Multi-Signal Coherence Analysis
      {% if gpu_enabled %}
      <span class="gpu-badge">‚ö° GPU ACCELERATED</span>
      {% endif %}
    </h1>

    <div class="info-box">
      <h3 style="margin-top: 0;">üìä Wavelet Phase Coherence</h3>
      <p><strong>Purpose:</strong> Analyze synchronization and phase relationships between multiple signals.</p>
      <p><strong>Features:</strong></p>
      <ul>
        <li>Time-averaged coherence (0-1 scale)</li>
        <li>Time-localized coherence heatmaps</li>
        <li>Phase difference analysis</li>
        <li>GPU-accelerated batch processing</li>
      </ul>
      <p><strong>Upload 2-6 signals:</strong> CSV or MAT files with equal lengths and same sampling rate.</p>
    </div>

    <div class="upload-form">
      <h2>Upload Signals</h2>
      <form id="analysisForm">
        <label for="fileInput">Select Signal Files (2-6 files):</label>
        <input type="file" id="fileInput" name="files" accept=".csv,.mat" multiple required>
        
        <div class="file-list" id="fileList"></div>

        <label for="fs">Sampling Frequency (Hz):</label>
        <input type="number" id="fs" name="fs" value="1.0" step="0.1" min="0.1" required>

        <label for="win">Window Size (seconds):</label>
        <input type="number" id="win" name="win" value="1.0" step="0.1" min="0.1" required>

        <label for="overlap">Window Overlap (0-1):</label>
        <input type="number" id="overlap" name="overlap" value="0.5" step="0.05" min="0" max="0.95" required>

        <label for="numcycles">Num Cycles (time-localized coherence):</label>
        <input type="number" id="numcycles" name="numcycles" value="10" step="1" min="1" required>

        <button type="submit" id="submitBtn">Analyze Coherence</button>
      </form>
    </div>

    <div class="progress-container" id="progressContainer">
      <h2>Processing...</h2>
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill">0%</div>
      </div>
      <div class="progress-stage" id="progressStage">Initializing...</div>
    </div>

    <div class="results" id="results">
      <h2>Coherence Results</h2>
      <p id="resultsInfo"></p>
      
      <div class="pair-selector" id="pairSelector"></div>
      
      <div id="plotsContainer"></div>
    </div>

    <a href="/" class="back-link">‚Üê Back to Single Signal Analysis</a>

    <script>
      let selectedFiles = [];
      let currentTaskId = null;
      let pollInterval = null;

      // File selection handling
      document.getElementById('fileInput').addEventListener('change', function(e) {
        selectedFiles = Array.from(e.target.files);
        updateFileList();
      });

      function updateFileList() {
        const fileList = document.getElementById('fileList');
        if (selectedFiles.length === 0) {
          fileList.innerHTML = '<p style="color: #999;">No files selected</p>';
          return;
        }

        fileList.innerHTML = '';
        selectedFiles.forEach((file, idx) => {
          const fileItem = document.createElement('div');
          fileItem.className = 'file-item';
          fileItem.innerHTML = `
            <span>${idx + 1}. ${file.name} (${(file.size / 1024).toFixed(1)} KB)</span>
            <button type="button" onclick="removeFile(${idx})">Remove</button>
          `;
          fileList.appendChild(fileItem);
        });

        // Validation
        if (selectedFiles.length < 2) {
          fileList.innerHTML += '<div class="warning">‚ö†Ô∏è At least 2 signals required</div>';
        } else if (selectedFiles.length > 6) {
          fileList.innerHTML += '<div class="warning">‚ö†Ô∏è Maximum 6 signals (will use first 6)</div>';
        } else {
          const nPairs = selectedFiles.length * (selectedFiles.length - 1) / 2;
          fileList.innerHTML += `<div class="info-box">‚úì ${selectedFiles.length} signals ‚Üí ${nPairs} pairs</div>`;
        }
      }

      function removeFile(idx) {
        selectedFiles.splice(idx, 1);
        // Update file input
        const dt = new DataTransfer();
        selectedFiles.forEach(f => dt.items.add(f));
        document.getElementById('fileInput').files = dt.files;
        updateFileList();
      }

      // Form submission
      document.getElementById('analysisForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        if (selectedFiles.length < 2) {
          alert('Please select at least 2 signal files');
          return;
        }

        const formData = new FormData();
        selectedFiles.forEach(file => formData.append('files', file));
        formData.append('fs', document.getElementById('fs').value);
        formData.append('win', document.getElementById('win').value);
        formData.append('overlap', document.getElementById('overlap').value);
        formData.append('numcycles', document.getElementById('numcycles').value);

        // Disable submit button
        const submitBtn = document.getElementById('submitBtn');
        submitBtn.disabled = true;
        submitBtn.textContent = 'Processing...';

        // Show progress
        document.getElementById('progressContainer').style.display = 'block';
        document.getElementById('results').style.display = 'none';

        try {
          const response = await fetch('/analyze_coherence', {
            method: 'POST',
            body: formData
          });

          const data = await response.json();

          if (response.ok) {
            currentTaskId = data.task_id;
            startPolling();
          } else {
            showError(data.error || 'Analysis failed');
            submitBtn.disabled = false;
            submitBtn.textContent = 'Analyze Coherence';
          }
        } catch (error) {
          showError('Network error: ' + error.message);
          submitBtn.disabled = false;
          submitBtn.textContent = 'Analyze Coherence';
        }
      });

      function startPolling() {
        pollInterval = setInterval(checkStatus, 500);
      }

      async function checkStatus() {
        try {
          const response = await fetch(`/status/${currentTaskId}`);
          const data = await response.json();

          updateProgress(data.progress, data.stage);

          if (data.error) {
            clearInterval(pollInterval);
            showError(data.error);
            document.getElementById('submitBtn').disabled = false;
            document.getElementById('submitBtn').textContent = 'Analyze Coherence';
          } else if (data.result) {
            clearInterval(pollInterval);
            showResults(data.result);
            document.getElementById('submitBtn').disabled = false;
            document.getElementById('submitBtn').textContent = 'Analyze Coherence';
          }
        } catch (error) {
          console.error('Polling error:', error);
        }
      }

      function updateProgress(percent, stage) {
        document.getElementById('progressFill').style.width = percent + '%';
        document.getElementById('progressFill').textContent = percent + '%';
        document.getElementById('progressStage').textContent = stage;
      }

      function showError(message) {
        document.getElementById('progressContainer').innerHTML = `
          <div class="error">
            <strong>Error:</strong> ${message}
          </div>
        `;
      }

      function showResults(result) {
        document.getElementById('progressContainer').style.display = 'none';
        document.getElementById('results').style.display = 'block';

        const nPairs = result.n_pairs;
        const signalNames = result.signal_names;
        document.getElementById('resultsInfo').innerHTML = `
          Analyzed ${signalNames.length} signals (${nPairs} pairs)<br>
          <strong>Signals:</strong> ${signalNames.join(', ')}
        `;

        // Create pair selector buttons
        const pairSelector = document.getElementById('pairSelector');
        pairSelector.innerHTML = '';
        const pairKeys = Object.keys(result.pair_plots);
        
        pairKeys.forEach((pairKey, idx) => {
          const btn = document.createElement('button');
          btn.className = 'pair-button' + (idx === 0 ? ' active' : '');
          btn.textContent = pairKey.replace('_vs_', ' ‚Üî ').replace(/\.csv|\.mat/g, '');
          btn.onclick = () => selectPair(pairKey, btn);
          pairSelector.appendChild(btn);
        });

        // Show first pair by default
        showPair(pairKeys[0], result.pair_plots);
      }

      function selectPair(pairKey, btn) {
        // Update active button
        document.querySelectorAll('.pair-button').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        // Fetch and show the pair's plot
        fetch(`/status/${currentTaskId}`)
          .then(r => r.json())
          .then(data => showPair(pairKey, data.result.pair_plots));
      }

      function showPair(pairKey, pairPlots) {
        const plotsContainer = document.getElementById('plotsContainer');
        plotsContainer.innerHTML = '<div class="plot-container" id="coherencePlot"></div>';
        
        const plotData = JSON.parse(pairPlots[pairKey]);
        Plotly.newPlot('coherencePlot', plotData.data, plotData.layout);
      }
    </script>
  </body>
</html>
